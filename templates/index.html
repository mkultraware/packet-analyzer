<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Packet Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: monospace; background: #0d0d0d; color: #00ccff; padding: 20px; }
    h1 { border-bottom: 1px solid #00ccff; padding-bottom: 10px; margin-bottom: 20px; }
    h3 { color: #aaa; margin-bottom: 10px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .card { background: #1a1a1a; padding: 15px; border: 1px solid #00ccff33; border-radius: 6px; }
    .full { grid-column: span 2; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
    td, th { padding: 6px 8px; border-bottom: 1px solid #222; text-align: left; }
    th { color: #666; }
    tr:hover { background: #222; }
    canvas { max-height: 220px; }
    .stat { font-size: 2em; color: #00ccff; font-weight: bold; }
    .badge { 
      display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 0.8em;
      background: #003344;
    }
    .badge.dns { background: #003300; color: #00ff88; }
    .badge.http { background: #330000; color: #ff6666; }
    .badge.tcp { background: #002233; color: #66aaff; }
    .badge.udp { background: #222200; color: #ffcc00; }
  </style>
</head>
<body>
  <h1>ðŸ“¡ Network Packet Analyzer</h1>

  <div class="grid">
    <div class="card">
      <h3>Total Packets Captured</h3>
      <div class="stat" id="total">â€”</div>
    </div>
    <div class="card">
      <h3>Protocol Breakdown</h3>
      <canvas id="protocolChart"></canvas>
    </div>
    <div class="card full">
      <h3>Traffic Over Last Hour</h3>
      <canvas id="timelineChart"></canvas>
    </div>
    <div class="card">
      <h3>Top DNS Queries</h3>
      <table>
        <thead><tr><th>Domain</th><th>Count</th></tr></thead>
        <tbody id="dns-table"></tbody>
      </table>
    </div>
    <div class="card">
      <h3>Top Destinations</h3>
      <table>
        <thead><tr><th>IP</th><th>Packets</th></tr></thead>
        <tbody id="dest-table"></tbody>
      </table>
    </div>
    <div class="card full">
      <h3>Recent Packets</h3>
      <table>
        <thead><tr><th>Time</th><th>Protocol</th><th>Source</th><th>Destination</th><th>Detail</th></tr></thead>
        <tbody id="recent-table"></tbody>
      </table>
    </div>
  </div>

  <script>
    let protocolChart, timelineChart;

    function getBadge(protocol) {
      const p = protocol.toLowerCase();
      return `<span class="badge ${p}">${protocol}</span>`;
    }

    async function loadData() {
      const res = await fetch("/api/stats");
      const data = await res.json();

      document.getElementById("total").textContent = data.total.toLocaleString();

      // Protocol donut chart
      const pLabels = data.protocols.map(p => p.protocol);
      const pCounts = data.protocols.map(p => p.count);
      const colors = ["#00ccff", "#00ff88", "#ff6666", "#ffcc00", "#cc66ff"];

      if (protocolChart) protocolChart.destroy();
      protocolChart = new Chart(document.getElementById("protocolChart"), {
        type: "doughnut",
        data: { labels: pLabels, datasets: [{ data: pCounts, backgroundColor: colors }] },
        options: { plugins: { legend: { labels: { color: "#aaa" } } } }
      });

      // Timeline chart
      if (timelineChart) timelineChart.destroy();
      timelineChart = new Chart(document.getElementById("timelineChart"), {
        type: "line",
        data: {
          labels: data.timeline.map(t => t.minute),
          datasets: [{
            label: "Packets",
            data: data.timeline.map(t => t.count),
            borderColor: "#00ccff",
            backgroundColor: "rgba(0,204,255,0.1)",
            tension: 0.3, fill: true
          }]
        },
        options: { scales: { y: { beginAtZero: true, ticks: { color: "#666" } }, x: { ticks: { color: "#666" } } }, plugins: { legend: { display: false } } }
      });

      // DNS table
      document.getElementById("dns-table").innerHTML = data.dns_queries.map(r =>
        `<tr><td>${r.detail.replace("Query: ", "")}</td><td>${r.count}</td></tr>`
      ).join("");

      // Destinations table
      document.getElementById("dest-table").innerHTML = data.top_destinations.map(r =>
        `<tr><td>${r.dst_ip}</td><td>${r.count}</td></tr>`
      ).join("");

      // Recent packets
      document.getElementById("recent-table").innerHTML = data.recent.map(r =>
        `<tr>
          <td>${r.timestamp.split("T")[1].split(".")[0]}</td>
          <td>${getBadge(r.protocol)}</td>
          <td>${r.src_ip}</td>
          <td>${r.dst_ip}</td>
          <td style="color:#888;font-size:0.85em">${r.detail}</td>
        </tr>`
      ).join("");
    }

    loadData();
    setInterval(loadData, 5000); // refresh every 5 seconds
  </script>
</body>
</html>
